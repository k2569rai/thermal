<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heat Transfer Lab v15.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-bg: #f4f6f8;
        }
        body {
            background-color: var(--primary-bg);
            font-family: 'Segoe UI', sans-serif;
            padding-bottom: 100px;
        }
        
        /* Navigation Styles */
        .nav-pills .nav-link {
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: bold;
            color: #555;
            background: #e9ecef;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
        }
        .nav-pills .nav-link .bi { margin-right: 5px; }

        /* Card & Input Styles */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }
        .card-header {
            background: white;
            font-weight: 700;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .form-control, .form-select, .btn {
            min-height: 48px;
            font-size: 16px;
        }
        
        /* Chart Containers */
        .chart-wrapper {
            position: relative;
            height: 350px;
            width: 100%;
        }
        
        /* Tab 1: Layer Items */
        .layer-item {
            background: white;
            border: 1px solid #dee2e6;
            border-left: 5px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }
        .mode-plane .layer-item { border-left-color: #3498db; }
        .mode-cyl .layer-item { border-left-color: #e67e22; }

        /* Tab 2: Sphere Animation */
        .anim-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 220px;
            background: #212529;
            border-radius: 12px;
            color: white;
        }
        .sim-sphere {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #ff0000;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3) inset, 0 10px 20px rgba(0,0,0,0.5);
            transition: background-color 0.1s linear;
        }

        /* Tab 3: Fin Result Box */
        .fin-result-box {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
        }

        /* Tab 5: Diffusion Canvas */
        .canvas-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 10px;
            margin-bottom: 20px;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Utilities */
        .text-xs { font-size: 0.85rem; }
        .input-hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4 shadow-sm">
    <div class="container-fluid justify-content-center">
        <span class="navbar-brand mb-0 h1 fw-bold"><i class="bi bi-mortarboard-fill"></i> Heat Transfer Lab v15.1</span>
    </div>
</nav>

<div class="container-md">
    
    <ul class="nav nav-pills mb-4 justify-content-center" id="mainTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="steady-tab" data-bs-toggle="pill" data-bs-target="#steady" type="button" role="tab"><i class="bi bi-layers"></i> 多層熱伝導</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transient-tab" data-bs-toggle="pill" data-bs-target="#transient" type="button" role="tab"><i class="bi bi-clock-history"></i> 非定常冷却</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="fin-tab" data-bs-toggle="pill" data-bs-target="#fin" type="button" role="tab"><i class="bi bi-grid-3x3"></i> フィン設計</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="flow-tab" data-bs-toggle="pill" data-bs-target="#flow" type="button" role="tab"><i class="bi bi-wind"></i> 強制対流</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="diffusion-tab" data-bs-toggle="pill" data-bs-target="#diffusion" type="button" role="tab"><i class="bi bi-fire"></i> 1D熱拡散</button>
        </li>
    </ul>

    <div class="tab-content" id="mainTabContent">
        
        <div class="tab-pane fade show active" id="steady" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-5">
                    <div class="card bg-light">
                        <div class="card-body p-2 text-center">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="geomMode" id="mode-plane" autocomplete="off" checked onchange="ss_setMode('plane')">
                                <label class="btn btn-outline-primary" for="mode-plane">平板 (Wall)</label>
                                <input type="radio" class="btn-check" name="geomMode" id="mode-cyl" autocomplete="off" onchange="ss_setMode('cylinder')">
                                <label class="btn btn-outline-warning" for="mode-cyl">円筒 (Pipe)</label>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><i class="bi bi-sliders"></i> 境界条件・形状</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label text-xs text-muted">計算ターゲット</label>
                                <select class="form-select form-select-sm" id="ss-target" onchange="ss_updateInputs()">
                                    <option value="Tin">QとToutから → 内温(Tin)を計算</option>
                                    <option value="Q">TinとToutから → 熱量(Q)を計算</option>
                                </select>
                            </div>

                            <div class="row g-2">
                                <div class="col-6 ss-grp-Q">
                                    <label class="form-label text-xs fw-bold text-danger">熱量 Q (W)</label>
                                    <input type="number" id="ss-Q" class="form-control" value="50">
                                </div>
                                <div class="col-6 ss-grp-Tin input-hidden">
                                    <label class="form-label text-xs fw-bold text-danger">内温 Tin (℃)</label>
                                    <input type="number" id="ss-Tin" class="form-control" value="100">
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-xs fw-bold text-primary">外気温 Tout (℃)</label>
                                    <input type="number" id="ss-Tout" class="form-control" value="20">
                                </div>
                                
                                <div class="col-12" id="ss-div-A">
                                    <label class="form-label text-xs">伝熱面積 A (mm²)</label>
                                    <input type="number" id="ss-A" class="form-control" value="10000">
                                </div>
                                <div class="col-6 input-hidden" id="ss-div-L">
                                    <label class="form-label text-xs">長さ L (m)</label>
                                    <input type="number" id="ss-L" class="form-control" value="1.0">
                                </div>
                                <div class="col-6 input-hidden" id="ss-div-ID">
                                    <label class="form-label text-xs">内径 ID (mm)</label>
                                    <input type="number" id="ss-ID" class="form-control" value="10">
                                </div>
                                
                                <div class="col-12 mt-2 pt-2 border-top">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="ss-check-flux" onchange="ss_toggleFlux()">
                                        <label class="form-check-label text-xs" for="ss-check-flux">日射・熱流束あり</label>
                                    </div>
                                    <div class="mt-2 input-hidden" id="ss-div-flux">
                                        <label class="form-label text-xs">入射熱流束 q" (W/m²)</label>
                                        <input type="number" id="ss-flux" class="form-control border-warning" value="1000">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between py-2 align-items-center">
                            <span>層構成</span>
                            <button class="btn btn-sm btn-outline-primary rounded-circle" onclick="ss_addLayer()"><i class="bi bi-plus-lg"></i></button>
                        </div>
                        <div class="card-body bg-light p-2" id="ss-layers"></div>
                    </div>

                    <div class="card">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-7"><label class="text-xs">外気熱伝達率 h</label></div>
                                <div class="col-5"><input type="number" id="ss-h" class="form-control form-control-sm" value="10"></div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary w-100 fw-bold" onclick="ss_calc()">計算実行</button>
                </div>

                <div class="col-lg-7">
                    <div class="card bg-white border-primary mb-3" id="ss-res" style="display:none">
                        <div class="card-body text-center">
                            <div class="row">
                                <div class="col-6 border-end">
                                    <div class="text-muted text-xs" id="ss-res-lbl">結果</div>
                                    <div class="fs-2 fw-bold text-danger" id="ss-res-val">--</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted text-xs">総熱抵抗</div>
                                    <div class="fs-4" id="ss-res-R">--</div>
                                    <div class="text-xs">K/W</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-center text-muted text-xs">温度分布</h6>
                            <div class="chart-wrapper"><canvas id="ss-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="transient" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">条件設定</div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="text-xs text-muted">形状</label>
                                <select class="form-select form-select-sm" id="tr-shape">
                                    <option value="sphere">球 (Sphere)</option>
                                    <option value="cube">立方体 (Cube)</option>
                                    <option value="plate">平板 (Plate)</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="text-xs text-muted">代表長さ/直径 (mm)</label>
                                <input type="number" id="tr-dim" class="form-control" value="10">
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <label class="text-xs text-muted">初期 Ti (℃)</label>
                                    <input type="number" id="tr-Ti" class="form-control" value="200">
                                </div>
                                <div class="col-6">
                                    <label class="text-xs text-muted">流体 Tf (℃)</label>
                                    <input type="number" id="tr-Tf" class="form-control" value="20">
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="row g-2 mb-2">
                                <div class="col-6"><label class="text-xs text-muted">ρ (kg/m³)</label><input type="number" id="tr-rho" class="form-control form-control-sm" value="2688"></div>
                                <div class="col-6"><label class="text-xs text-muted">Cp (J/kgK)</label><input type="number" id="tr-cp" class="form-control form-control-sm" value="905"></div>
                                <div class="col-6"><label class="text-xs text-muted">k (W/mK)</label><input type="number" id="tr-k" class="form-control form-control-sm" value="236"></div>
                                <div class="col-6"><label class="text-xs text-muted">h (W/m²K)</label><input type="number" id="tr-h" class="form-control form-control-sm" value="20"></div>
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-primary flex-grow-1" onclick="tr_calc()">計算</button>
                                <button class="btn btn-danger flex-grow-1" onclick="tr_play_anim()"><i class="bi bi-play-fill"></i> 再生</button>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header bg-dark text-white text-xs">シミュレーション</div>
                        <div class="card-body p-0">
                            <div class="anim-container">
                                <div class="sim-sphere" id="anim-sphere"></div>
                                <div class="mt-3 font-monospace">
                                    t = <span id="anim-time">0.0</span> s<br>
                                    T = <span id="anim-temp">--</span> ℃
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card mb-3 bg-light">
                        <div class="card-body py-2">
                            <div class="row text-center">
                                <div class="col-4 border-end">
                                    <div class="text-xs text-muted">Biot数</div>
                                    <div class="fw-bold" id="tr-bi">--</div>
                                    <div class="text-xs" id="tr-bi-check">--</div>
                                </div>
                                <div class="col-4 border-end">
                                    <div class="text-xs text-muted">時定数 τ (s)</div>
                                    <div class="fw-bold" id="tr-tau">--</div>
                                </div>
                                <div class="col-4">
                                    <div class="text-xs text-muted">10分後</div>
                                    <div class="fw-bold text-danger fs-5" id="tr-res-10min">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="chart-wrapper"><canvas id="tr-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="fin" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">フィンパラメータ</div>
                        <div class="card-body">
                            <label class="text-xs text-muted">フィン形状</label>
                            <select class="form-select mb-2" id="fin-shape">
                                <option value="pin">円柱フィン (Pin)</option>
                                <option value="rect">矩形フィン (Rect)</option>
                            </select>
                            <div class="row g-2 mb-2">
                                <div class="col-6"><label class="text-xs text-muted">D (mm)</label><input type="number" id="fin-D" class="form-control" value="3"></div>
                                <div class="col-6"><label class="text-xs text-muted">L (mm)</label><input type="number" id="fin-L" class="form-control" value="30"></div>
                            </div>
                            <hr class="my-2">
                            <div class="row g-2 mb-2">
                                <div class="col-6"><label class="text-xs text-muted">k</label><input type="number" id="fin-k" class="form-control form-control-sm" value="250"></div>
                                <div class="col-6"><label class="text-xs text-muted">h</label><input type="number" id="fin-h" class="form-control form-control-sm" value="100"></div>
                                <div class="col-6"><label class="text-xs text-muted">Tb</label><input type="number" id="fin-Tb" class="form-control form-control-sm" value="100"></div>
                                <div class="col-6"><label class="text-xs text-muted">Tf</label><input type="number" id="fin-Tf" class="form-control form-control-sm" value="20"></div>
                            </div>
                            <button class="btn btn-success w-100 mt-2" onclick="fin_calc()">計算</button>
                        </div>
                    </div>
                    <div class="card mt-2 border-warning">
                        <div class="card-body">
                            <h6 class="text-xs fw-bold">CPU冷却 全体計算</h6>
                            <div class="mb-2"><label class="text-xs text-muted">総発熱量 Q_cpu (W)</label><input type="number" id="fin-Qcpu" class="form-control" value="250"></div>
                            <div class="mb-2"><label class="text-xs text-muted">フィン本数 N</label><input type="number" id="fin-N" class="form-control" value="100"></div>
                            <button class="btn btn-outline-warning w-100 btn-sm" onclick="fin_solve_length()">必要な長さを逆算</button>
                            <div class="mt-2 text-center text-danger fw-bold" id="fin-req-L"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="fin-result-box mb-3">
                        <div class="row text-center">
                            <div class="col-4"><div class="text-xs text-muted">m</div><div class="fw-bold" id="fin-m">--</div></div>
                            <div class="col-4"><div class="text-xs text-muted">効率 η</div><div class="fw-bold text-success" id="fin-eff">--</div></div>
                            <div class="col-4"><div class="text-xs text-muted">放熱量 (1本)</div><div class="fw-bold text-primary" id="fin-q">-- W</div></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="chart-wrapper"><canvas id="fin-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="flow" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header border-info">A. 円管内流れ (Gz数)</div>
                        <div class="card-body">
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="text-xs fw-bold">D (mm)</label><input type="number" id="gz-D" class="form-control" value="10"></div>
                                <div class="col-6"><label class="text-xs fw-bold">x (m)</label><input type="number" id="gz-x" class="form-control" value="0.5"></div>
                                <div class="col-4"><label class="text-xs text-muted">Re</label><input type="number" id="gz-Re" class="form-control form-control-sm" value="200"></div>
                                <div class="col-4"><label class="text-xs text-muted">Pr</label><input type="number" id="gz-Pr" class="form-control form-control-sm" value="7.1"></div>
                                <div class="col-4"><label class="text-xs text-muted">k</label><input type="number" id="gz-k" class="form-control form-control-sm" value="0.6"></div>
                            </div>
                            <button class="btn btn-info w-100 text-white fw-bold mb-3" onclick="calc_graetz()">計算</button>
                            <div class="bg-light p-3 rounded mb-3">
                                <div class="row text-center">
                                    <div class="col-4 border-end"><div class="text-xs text-muted">Gz</div><div class="fw-bold" id="gz-res-Gz">--</div></div>
                                    <div class="col-4 border-end"><div class="text-xs text-muted">Nu</div><div class="fw-bold text-primary" id="gz-res-Nu">--</div></div>
                                    <div class="col-4"><div class="text-xs text-muted">h</div><div class="fw-bold text-success" id="gz-res-h">--</div></div>
                                </div>
                            </div>
                            <div class="chart-wrapper" style="height: 250px;"><canvas id="gz-chart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header border-danger">B. 熱線流速計 (逆算)</div>
                        <div class="card-body">
                            <div class="row g-2 mb-3">
                                <div class="col-12"><label class="text-xs fw-bold">線径 d (µm)</label><input type="number" id="hw-d" class="form-control border-danger" value="5"></div>
                                <div class="col-6"><label class="text-xs text-muted">Tw (℃)</label><input type="number" id="hw-Tw" class="form-control" value="80"></div>
                                <div class="col-6"><label class="text-xs text-muted">Tf (℃)</label><input type="number" id="hw-Tf" class="form-control" value="20"></div>
                                <div class="col-12"><label class="text-xs fw-bold">P (W/m)</label><input type="number" id="hw-P" class="form-control" value="0.5"></div>
                                <div class="col-4"><label class="text-xs text-muted">ν</label><input type="text" id="hw-nu" class="form-control form-control-sm" value="1.5e-5"></div>
                                <div class="col-4"><label class="text-xs text-muted">Pr</label><input type="number" id="hw-Pr" class="form-control form-control-sm" value="0.71"></div>
                                <div class="col-4"><label class="text-xs text-muted">k</label><input type="number" id="hw-k" class="form-control form-control-sm" value="0.026"></div>
                            </div>
                            <button class="btn btn-danger w-100 fw-bold mb-3" onclick="calc_hotwire()">流速u 逆算</button>
                            <div class="alert alert-danger text-center">
                                <div class="small text-muted mb-1">推定流速 u</div>
                                <div class="fs-2 fw-bold" id="hw-res-u">-- m/s</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="diffusion" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-8">
                    <div class="mb-2 fw-bold text-secondary"><i class="bi bi-palette"></i> 温度分布 (ヒートマップ)</div>
                    <div class="canvas-container" style="height: 120px;">
                        <canvas id="df-map"></canvas>
                    </div>
                    <div class="mb-2 mt-3 fw-bold text-secondary"><i class="bi bi-graph-up"></i> 温度プロファイル (グラフ)</div>
                    <div class="canvas-container" style="height: 300px;">
                        <canvas id="df-graph"></canvas>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><i class="bi bi-sliders"></i> 設定 (差分法)</div>
                        <div class="card-body">
                            <div class="d-grid gap-2 mb-4">
                                <button class="btn btn-primary" id="df-btn-toggle" onclick="df_toggleSim()"><i class="bi bi-play-fill"></i> スタート</button>
                                <button class="btn btn-secondary" onclick="df_resetSim()"><i class="bi bi-arrow-counterclockwise"></i> リセット</button>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">左端温度 (熱源)</label>
                                <input type="range" class="form-range" id="df-Tleft" min="0" max="300" value="100" oninput="df_updateLabel()">
                                <div class="text-end text-danger fw-bold" id="df-lbl-Tleft">100 ℃</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">初期温度</label>
                                <input type="number" class="form-control" id="df-Tinit" value="20" onchange="df_resetSim()">
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">熱拡散率 α (素材)</label>
                                <select class="form-select mb-1" id="df-mat" onchange="document.getElementById('df-alpha').value=this.value">
                                    <option value="97">アルミ (速い)</option>
                                    <option value="13">鉄 (普通)</option>
                                    <option value="0.5">ガラス (遅い)</option>
                                    <option value="0.1">木材 (超遅い)</option>
                                </select>
                                <input type="range" class="form-range" id="df-alpha" min="0.1" max="100" step="0.1" value="97">
                            </div>

                            <hr>
                            <div class="mb-2 text-center">
                                <label class="small text-muted">経過時間</label>
                                <div class="fs-3 fw-bold font-monospace"><span id="df-time">0.00</span> s</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // --- GLOBAL CONSTANTS ---
    const PRESETS = {
        "fe": {k: 50, l: "鉄"},
        "al": {k: 237, l: "アルミ"},
        "sus": {k: 16, l: "SUS"},
        "ins": {k: 0.04, l: "断熱材"},
        "con": {k: 1.0, l: "コンクリ"},
        "wood": {k: 0.07, l: "木材"}
    };
    
    // Chart Instances
    let chartSS = null;
    let chartTR = null;
    let chartFIN = null;
    let chartGZ = null;

    // --- TAB 1: STEADY STATE LOGIC ---
    let ssMode = 'plane';

    function ss_setMode(m) {
        ssMode = m;
        document.body.className = (m === 'plane') ? 'mode-plane' : 'mode-cyl';
        const show = (id, v) => document.getElementById(id).classList.toggle('input-hidden', !v);
        show('ss-div-A', m === 'plane');
        show('ss-div-L', m === 'cylinder');
        show('ss-div-ID', m === 'cylinder');
        ss_renderLayers();
    }

    function ss_updateInputs() {
        const t = document.getElementById('ss-target').value;
        const show = (sel, v) => document.querySelector(sel).classList.toggle('input-hidden', !v);
        show('.ss-grp-Q', t !== 'Q');
        show('.ss-grp-Tin', t !== 'Tin');
    }

    function ss_toggleFlux() {
        const on = document.getElementById('ss-check-flux').checked;
        document.getElementById('ss-div-flux').classList.toggle('input-hidden', !on);
    }

    function ss_addLayer(n = "", d = "", k = "") {
        const id = "L" + Math.random().toString(36).substr(2, 5);
        let opts = `<option value="">--素材--</option>`;
        for (let key in PRESETS) opts += `<option value="${PRESETS[key].k}">${PRESETS[key].l}</option>`;
        const lbl = ssMode === 'plane' ? '厚み(mm)' : '外径(mm)';

        const html = `
        <div class="layer-item" id="${id}">
            <button class="btn-close position-absolute top-0 end-0 m-2" onclick="document.getElementById('${id}').remove()"></button>
            <div class="row g-2 align-items-end">
                <div class="col-6"><label class="text-xs mb-0">名前</label><input type="text" class="form-control form-control-sm i-n" value="${n||'Layer'}"></div>
                <div class="col-6"><label class="text-xs mb-0">素材</label><select class="form-select form-select-sm" onchange="this.closest('.layer-item').querySelector('.i-k').value=this.value">${opts}</select></div>
                <div class="col-6"><label class="text-xs mb-0 fw-bold lbl-dim">${lbl}</label><input type="number" class="form-control form-control-sm i-d" value="${d}"></div>
                <div class="col-6"><label class="text-xs mb-0">k (W/mK)</label><input type="number" class="form-control form-control-sm i-k" value="${k}"></div>
            </div>
        </div>`;
        document.getElementById('ss-layers').insertAdjacentHTML('beforeend', html);
    }

    function ss_renderLayers() {
        const container = document.getElementById('ss-layers');
        if (container.children.length === 0) ss_addLayer('壁', 20, 1.0);
        const lbl = ssMode === 'plane' ? '厚み(mm)' : '外径(mm)';
        container.querySelectorAll('.lbl-dim').forEach(e => e.innerText = lbl);
    }

    function ss_calc() {
        let R_sum = 0, layers = [], lastGeom = 0;
        const get = id => parseFloat(document.getElementById(id).value);

        if (ssMode === 'plane') {
            const A = get('ss-A') / 1e6;
            document.querySelectorAll('#ss-layers .layer-item').forEach(el => {
                const d = parseFloat(el.querySelector('.i-d').value);
                const k = parseFloat(el.querySelector('.i-k').value);
                const n = el.querySelector('.i-n').value;
                if (d > 0) {
                    const R = (d / 1000) / (k * A);
                    layers.push({ R, n, dim: d });
                    R_sum += R;
                }
            });
        } else {
            const L = get('ss-L');
            let r_curr = get('ss-ID') / 2000;
            document.querySelectorAll('#ss-layers .layer-item').forEach(el => {
                const OD = parseFloat(el.querySelector('.i-d').value);
                const k = parseFloat(el.querySelector('.i-k').value);
                const n = el.querySelector('.i-n').value;
                const r_out = OD / 2000;
                if (r_out > r_curr) {
                    const R = Math.log(r_out / r_curr) / (2 * Math.PI * L * k);
                    layers.push({ R, n, r_in: r_curr, r_out: r_out });
                    R_sum += R;
                    r_curr = r_out;
                }
            });
            lastGeom = r_curr;
        }

        const h = get('ss-h');
        let Asurf = 0;
        if (ssMode === 'plane') Asurf = get('ss-A') / 1e6;
        else Asurf = 2 * Math.PI * lastGeom * get('ss-L');
        const R_conv = 1 / (h * Asurf);
        R_sum += R_conv;

        // Flux Check
        const hasFlux = document.getElementById('ss-check-flux').checked;
        if (hasFlux && ssMode === 'plane' && layers.length > 0) {
            const q_flux = parseFloat(document.getElementById('ss-flux').value);
            const Tback = 20; // Assumption for asphalt exercise
            const Tout = get('ss-Tout');
            const R_cond = layers[0].R;
            const Ts = (q_flux + h * Tout + Tback / R_cond) / (h + 1 / R_cond);
            document.getElementById('ss-res').style.display = 'block';
            document.getElementById('ss-res-lbl').innerText = "アスファルト表面温度";
            document.getElementById('ss-res-val').innerText = Ts.toFixed(1) + "℃";
            return;
        }

        const tgt = document.getElementById('ss-target').value;
        const Tout = get('ss-Tout');
        let Q = 0, Tin = 0;

        if (tgt === 'Tin') {
            Q = get('ss-Q');
            Tin = Tout + (Q * R_sum);
        } else {
            Tin = get('ss-Tin');
            Q = (Tin - Tout) / R_sum;
        }

        document.getElementById('ss-res').style.display = 'block';
        document.getElementById('ss-res-R').innerText = R_sum.toFixed(3);
        if (tgt === 'Tin') {
            document.getElementById('ss-res-lbl').innerText = "内温 Tin";
            document.getElementById('ss-res-val').innerText = Tin.toFixed(1) + "℃";
        } else {
            document.getElementById('ss-res-lbl').innerText = "熱量 Q";
            document.getElementById('ss-res-val').innerText = Q.toFixed(1) + "W";
        }

        let pts = [{ x: 0, y: Tin, label: '内側' }], cx = 0, ct = Tin;
        layers.forEach(l => {
            l.dT = Q * l.R;
            ct -= l.dT;
            if (ssMode === 'plane') cx += l.dim;
            else cx = l.r_out * 1000;
            pts.push({ x: cx, y: ct, label: l.n || 'Layer' });
        });
        pts.push({ x: cx * 1.15, y: Tout, label: '外気' });

        const ctx = document.getElementById('ss-chart').getContext('2d');
        if (chartSS) chartSS.destroy();
        chartSS = new Chart(ctx, {
            type: 'scatter',
            data: { datasets: [{ label: '温度分布', data: pts, showLine: true, borderColor: '#0d6efd' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- TAB 2: TRANSIENT LOGIC ---
    let tr_params = {};
    let tr_anim_id = null;

    function tr_calc() {
        const get = id => parseFloat(document.getElementById(id).value);
        const L_raw = get('tr-dim') / 1000;
        const shape = document.getElementById('tr-shape').value;
        let Lc = 0;
        if (shape === 'sphere' || shape === 'cube') Lc = L_raw / 6;
        else Lc = L_raw / 2;

        const k = get('tr-k'), h = get('tr-h'), rho = get('tr-rho'), cp = get('tr-cp');
        const Ti = get('tr-Ti'), Tf = get('tr-Tf');

        const Bi = (h * Lc) / k;
        document.getElementById('tr-bi').innerText = Bi.toFixed(4);
        document.getElementById('tr-bi-check').innerText = (Bi < 0.1) ? "OK (集中熱容量法)" : "注意 (Bi > 0.1)";
        document.getElementById('tr-bi-check').className = (Bi < 0.1) ? "text-success text-xs" : "text-danger text-xs fw-bold";

        const tau = (rho * cp * Lc) / h;
        document.getElementById('tr-tau').innerText = tau.toFixed(1);

        const t_10min = 600;
        const T_10 = Tf + (Ti - Tf) * Math.exp(-t_10min / tau);
        document.getElementById('tr-res-10min').innerText = T_10.toFixed(1) + "℃";

        let pts = [];
        const maxTime = tau * 5;
        for (let i = 0; i <= 50; i++) {
            const t = (maxTime * i) / 50;
            const T = Tf + (Ti - Tf) * Math.exp(-t / tau);
            pts.push({ x: t, y: T });
        }

        tr_params = { Ti, Tf, tau, maxTime };

        const ctx = document.getElementById('tr-chart').getContext('2d');
        if (chartTR) chartTR.destroy();
        chartTR = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'T(t)', data: pts, showLine: true, borderColor: '#dc3545', pointRadius: 0 },
                    { label: 'Cur', data: [], pointRadius: 6, pointBackgroundColor: 'orange' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        if (tr_anim_id) cancelAnimationFrame(tr_anim_id);
        tr_updateSphere(Ti, Ti, Tf);
        document.getElementById('anim-time').innerText = "0.0";
        document.getElementById('anim-temp').innerText = Ti.toFixed(1);
    }

    function tr_play_anim() {
        if (!tr_params.tau) { alert("先に計算してください"); return; }
        if (tr_anim_id) cancelAnimationFrame(tr_anim_id);

        const start = performance.now();
        const duration = 5000; 
        const simEnd = 600; 

        function loop(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1.0);
            const t = progress * simEnd;
            const T = tr_params.Tf + (tr_params.Ti - tr_params.Tf) * Math.exp(-t / tr_params.tau);

            document.getElementById('anim-time').innerText = t.toFixed(1);
            document.getElementById('anim-temp').innerText = T.toFixed(1);
            tr_updateSphere(T, tr_params.Ti, tr_params.Tf);

            chartTR.data.datasets[1].data = [{ x: t, y: T }];
            chartTR.update('none');

            if (progress < 1.0) tr_anim_id = requestAnimationFrame(loop);
        }
        tr_anim_id = requestAnimationFrame(loop);
    }

    function tr_updateSphere(T, Ti, Tf) {
        let r = (T - Tf) / (Ti - Tf);
        if (r < 0) r = 0; if (r > 1) r = 1;
        const hue = (1.0 - r) * 240; // 0=Red, 240=Blue
        document.getElementById('anim-sphere').style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
    }

    // --- TAB 3: FIN DESIGN LOGIC ---
    function fin_calc_core() {
        const get = id => parseFloat(document.getElementById(id).value);
        const D = get('fin-D') / 1000;
        const L = get('fin-L') / 1000;
        const k = get('fin-k'), h = get('fin-h');
        const Tb = get('fin-Tb'), Tf = get('fin-Tf');
        const shape = document.getElementById('fin-shape').value;

        let P = 0, Ac = 0;
        if (shape === 'pin') { P = Math.PI * D; Ac = Math.PI * D * D / 4; }
        else { P = 4 * D; Ac = D * D; }

        const m = Math.sqrt((h * P) / (k * Ac));
        const eff = Math.tanh(m * L) / (m * L);
        const theta_b = Tb - Tf;
        const Q_fin = Math.sqrt(h * P * k * Ac) * theta_b * Math.tanh(m * L);

        return { m, eff, Q_fin, theta_b, h, P, k, Ac, L_curr: L };
    }

    function fin_calc() {
        const res = fin_calc_core();
        document.getElementById('fin-m').innerText = res.m.toFixed(1);
        document.getElementById('fin-eff').innerText = (res.eff * 100).toFixed(1) + "%";
        document.getElementById('fin-q').innerText = res.Q_fin.toFixed(2) + " W";

        let pts = [];
        const maxL = res.L_curr * 3;
        for (let i = 1; i <= 50; i++) {
            const l = (maxL * i) / 50;
            const q = Math.sqrt(res.h * res.P * res.k * res.Ac) * res.theta_b * Math.tanh(res.m * l);
            pts.push({ x: l * 1000, y: q });
        }

        const ctx = document.getElementById('fin-chart').getContext('2d');
        if (chartFIN) chartFIN.destroy();
        chartFIN = new Chart(ctx, {
            type: 'scatter',
            data: { datasets: [{ label: 'Q vs L', data: pts, showLine: true, borderColor: '#198754', pointRadius: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { title: { display: true, text: 'L (mm)' } }, y: { title: { display: true, text: 'Q (W)' } } }
            }
        });
    }

    function fin_solve_length() {
        const Q_total = parseFloat(document.getElementById('fin-Qcpu').value);
        const N = parseFloat(document.getElementById('fin-N').value);
        const Q_target = Q_total / N;
        const res = fin_calc_core();
        const M = Math.sqrt(res.h * res.P * res.k * res.Ac) * res.theta_b;

        if (Q_target >= M) {
            document.getElementById('fin-req-L').innerText = "不可能 (理論限界超え)";
            return;
        }
        const mL = Math.atanh(Q_target / M);
        const L_req = mL / res.m;
        document.getElementById('fin-req-L').innerText = "必要長さ: " + (L_req * 1000).toFixed(1) + " mm";
    }

    // --- TAB 4: CONVECTION LOGIC ---
    function calc_graetz() {
        const get = id => parseFloat(document.getElementById(id).value);
        const D = get('gz-D') / 1000;
        const x_target = get('gz-x');
        const Re = get('gz-Re'), Pr = get('gz-Pr'), k = get('gz-k');

        const Gz = (Re * Pr * D) / x_target;
        const Nu = 1.08 * Math.pow(Gz, 1 / 3);
        const h = (Nu * k) / D;

        document.getElementById('gz-res-Gz').innerText = Gz.toFixed(1);
        document.getElementById('gz-res-Nu').innerText = Nu.toFixed(2);
        document.getElementById('gz-res-h').innerText = h.toFixed(1);

        let pts = [];
        for (let i = 1; i <= 20; i++) {
            let xx = 0.05 * i;
            let gz = (Re * Pr * D) / xx;
            pts.push({ x: xx, y: 1.08 * Math.pow(gz, 1 / 3) });
        }

        const ctx = document.getElementById('gz-chart').getContext('2d');
        if (chartGZ) chartGZ.destroy();
        chartGZ = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'Nu vs x', data: pts, showLine: true, borderColor: '#0dcaf0', pointRadius: 0 },
                    { label: 'Target', data: [{ x: x_target, y: Nu }], pointRadius: 6, backgroundColor: 'red' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function calc_hotwire() {
        const get = id => parseFloat(document.getElementById(id).value);
        const d = get('hw-d') * 1e-6;
        const Tw = get('hw-Tw'), Tf = get('hw-Tf');
        const P = get('hw-P');
        const nu = parseFloat(document.getElementById('hw-nu').value);
        const Pr = get('hw-Pr'), k = get('hw-k');

        const h = P / (Math.PI * d * (Tw - Tf));
        const Nu = (h * d) / k;
        const Re = Math.pow(Nu / (0.8 * Math.pow(Pr, 0.5)), 2);
        const u = (Re * nu) / d;

        document.getElementById('hw-res-u').innerText = u.toFixed(2) + " m/s";
    }

    // --- TAB 5: 1D DIFFUSION (FIXED) ---
    // Variables for diffusion simulation
    const df_N = 100;
    const df_L = 0.5;
    let df_dx = df_L / (df_N - 1);
    let df_dt = 0.001;
    let df_T = new Float32Array(df_N);
    let df_Tn = new Float32Array(df_N);
    let df_time = 0;
    let df_running = false;
    let df_anim_id;

    // Elements
    const cvMap = document.getElementById('df-map');
    const ctxMap = cvMap.getContext('2d');
    const cvGraph = document.getElementById('df-graph');
    const ctxGraph = cvGraph.getContext('2d');

    // Resize Function (The fix for blank canvas)
    function df_resize() {
        // Force width/height based on container
        if (cvMap.offsetWidth > 0) {
            cvMap.width = cvMap.offsetWidth;
            cvMap.height = cvMap.offsetHeight;
            cvGraph.width = cvGraph.offsetWidth;
            cvGraph.height = cvGraph.offsetHeight;
            df_draw();
        }
    }

    function df_resetSim() {
        df_running = false;
        document.getElementById('df-btn-toggle').innerHTML = '<i class="bi bi-play-fill"></i> スタート';
        document.getElementById('df-btn-toggle').className = 'btn btn-primary';
        
        const Ti = parseFloat(document.getElementById('df-Tinit').value);
        const Tl = parseFloat(document.getElementById('df-Tleft').value);
        
        for (let i = 0; i < df_N; i++) df_T[i] = Ti;
        df_T[0] = Tl;
        df_time = 0;
        document.getElementById('df-time').innerText = "0.00";
        
        cancelAnimationFrame(df_anim_id);
        df_draw();
    }

    function df_toggleSim() {
        df_running = !df_running;
        const btn = document.getElementById('df-btn-toggle');
        if (df_running) {
            btn.innerHTML = '<i class="bi bi-pause-fill"></i> 停止';
            btn.className = 'btn btn-warning';
            df_loop();
        } else {
            btn.innerHTML = '<i class="bi bi-play-fill"></i> 再開';
            btn.className = 'btn btn-primary';
        }
    }

    function df_updateLabel() {
        const val = document.getElementById('df-Tleft').value;
        document.getElementById('df-lbl-Tleft').innerText = val + " ℃";
        if (df_running) df_T[0] = parseFloat(val);
    }

    function df_loop() {
        if (!df_running) return;

        const alphaScale = parseFloat(document.getElementById('df-alpha').value);
        const alpha = alphaScale * 1e-4; 
        
        // Stability check
        const max_dt = 0.5 * df_dx * df_dx / alpha;
        df_dt = max_dt * 0.9;
        const Fo = (alpha * df_dt) / (df_dx * df_dx);
        const Tleft = parseFloat(document.getElementById('df-Tleft').value);

        // Steps per frame
        for (let k = 0; k < 20; k++) {
            df_T[0] = Tleft;
            for (let i = 1; i < df_N - 1; i++) {
                df_Tn[i] = df_T[i] + Fo * (df_T[i + 1] - 2 * df_T[i] + df_T[i - 1]);
            }
            df_Tn[df_N - 1] = df_Tn[df_N - 2]; // Adiabatic
            
            for (let i = 1; i < df_N; i++) df_T[i] = df_Tn[i];
            df_time += df_dt;
        }

        document.getElementById('df-time').innerText = df_time.toFixed(2);
        df_draw();
        df_anim_id = requestAnimationFrame(df_loop);
    }

    function df_draw() {
        const w = cvMap.width;
        const hm = cvMap.height;
        const hg = cvGraph.height;
        
        // Safety check if canvas is 0 size
        if (w === 0) return;

        ctxMap.clearRect(0, 0, w, hm);
        ctxGraph.clearRect(0, 0, w, hg);

        const cw = w / df_N;
        const maxT = parseFloat(document.getElementById('df-Tleft').value) + 20;
        const minT = parseFloat(document.getElementById('df-Tinit').value) - 10;
        const range = maxT - minT;

        // Draw Map
        for (let i = 0; i < df_N; i++) {
            let ratio = (df_T[i] - minT) / range;
            if (ratio < 0) ratio = 0; if (ratio > 1) ratio = 1;
            const hue = (1.0 - ratio) * 240;
            ctxMap.fillStyle = `hsl(${hue}, 100%, 50%)`;
            ctxMap.fillRect(i * cw, 0, cw + 1, hm);
        }

        // Draw Graph
        ctxGraph.beginPath();
        ctxGraph.strokeStyle = "#aaa";
        ctxGraph.lineWidth = 1;
        ctxGraph.moveTo(0, hg); ctxGraph.lineTo(w, hg);
        ctxGraph.moveTo(0, 0); ctxGraph.lineTo(0, hg);
        ctxGraph.stroke();

        ctxGraph.beginPath();
        ctxGraph.strokeStyle = "#dc3545";
        ctxGraph.lineWidth = 3;
        for (let i = 0; i < df_N; i++) {
            const x = i * cw;
            const y = hg - ((df_T[i] - minT) / range) * hg;
            if (i === 0) ctxGraph.moveTo(x, y); else ctxGraph.lineTo(x, y);
        }
        ctxGraph.stroke();
    }

    // --- INITIALIZATION ---
    window.onload = () => {
        // Tab 1 Init
        ss_setMode('plane');
        ss_addLayer('壁', 20, 1.0);

        // Tab 5 Init
        df_resize();
        df_resetSim();
        
        // Listeners for resizing Canvas when tab shows
        const tabEl = document.getElementById('diffusion-tab');
        tabEl.addEventListener('shown.bs.tab', function (event) {
            df_resize();
            df_draw();
        });
        
        window.addEventListener('resize', df_resize);
    };
</script>
</body>
</html>